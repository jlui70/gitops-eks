---
- name: "[INFRA] Obter informaÃ§Ãµes dos nodes"
  kubernetes.core.k8s_info:
    kind: Node
    kubeconfig: "{{ kubeconfig_path | default('~/.kube/config') }}"
  register: nodes

- name: "[INFRA] Validar nodes estÃ£o Ready"
  assert:
    that:
      - nodes.resources | length > 0
      - item.status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
    fail_msg: "Node {{ item.metadata.name }} nÃ£o estÃ¡ Ready"
    success_msg: "âœ… Node {{ item.metadata.name }} estÃ¡ Ready"
  loop: "{{ nodes.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"

- name: "[NETWORK] Validar ALB Controller"
  kubernetes.core.k8s_info:
    kind: Deployment
    name: aws-load-balancer-controller
    namespace: kube-system
    kubeconfig: "{{ kubeconfig_path | default('~/.kube/config') }}"
  register: alb_controller

- name: "[NETWORK] Verificar ALB Controller Running"
  assert:
    that:
      - alb_controller.resources | length > 0
      - alb_controller.resources[0].status.readyReplicas == alb_controller.resources[0].spec.replicas
    success_msg: "âœ… ALB Controller: {{ alb_controller.resources[0].status.readyReplicas }}/{{ alb_controller.resources[0].spec.replicas }} replicas"

- name: "Gerar relatÃ³rio"
  debug:
    msg: |
      ========================================
      âœ… CLUSTER VALIDADO COM SUCESSO
      ========================================
      
      ğŸ“Š Nodes: {{ nodes.resources | length }} Ready
      ğŸŒ ALB Controller: Running
      
      ========================================
